---
title: "Car clubs in England"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(tidyverse)
library(sf)
library(sp)
library(tmap)
library(RColorBrewer)
library(readxl)
library(ggmap)
library(hexbin)
library(viridis)
library(cowplot)
library(gtools)
library(kableExtra)

#load data

#get LAD shapefile
load("../workspace_temp/LAD")
#get como data
comouk <- read.csv("../data/CoMoUK/comoukdata.csv")
#get tourism data
tourism <- read.csv("../data/contextual_open_data/tourism_wrangled.csv")
#get parking revenue data
revenue <- read.csv("../data/contextual_open_data/parking_revenue_wrangled.csv")

#create sf object
coords.tmp <- cbind(comouk$lon, comouk$lat)
comouk.sp <- SpatialPointsDataFrame(coords.tmp, data = data.frame(comouk))
comouk.sf <- st_as_sf(comouk.sp)
st_crs(comouk.sf) <- 4326 

#gather data at the LAD level
como_lad <- comouk %>%
  group_by(lad) %>%
  summarise(lad_name = lad_name[1], n_lots = n(), n_vehicles = sum(number_of_vehicles),
            n_operators = length(unique(operator)))

#add quantile of number of lots
como_lad$n_lots_q <- quantcut(como_lad$n_lots)

#create sf object
como_lad.sf <- left_join(select(lad.sf,lad,Region,geometry), como_lad)

#convert plotting variables to factor
como_lad.sf$n_operators <- factor(como_lad.sf$n_operators)
como_lad.sf$n_lots_q <- factor(como_lad.sf$n_lots_q)

#extract Lonon only
como_london.sf <- como_lad.sf %>%
  filter(Region == "London")

#UK map for plot backgrounds
UK <- map_data("world") %>% filter(region=="UK")

```

Paragraph 1 - motivation - CO2 emissions from car use etc. 2050 emissions goals.
Alternative transport options - car clubs (mention electric vehicles?)

Paragraph 2 - see notebook.

Map of car club locations: (recreating the map from CoMoUK)


```{r car_club_map}

tmap_mode("view")
mypalette <- c("#FF7F00","#4DAF4A" ,"#377EB8" ,"#984EA3" ,'#FFFF33')


como_map <- tm_shape(comouk.sf) +
  tm_dots(col = "operator", palette = mypalette, size = 0.2, title = "Operator", clustering = TRUE) + #, clustering = TRUE
  markerClusterOptions(freezeAtZoom = 5) +
  #tm_dots(size = 0.5, clustering = TRUE) +
  tmap_options(basemaps = "OpenStreetMap") +
  tm_layout(title = "Car club lot locations in the UK, scraped from como.org.uk")




```

Number of operators and car club bays per LAD. London has multiple operators, but there are areas outside of London with a high number of lots (e.g.), suggesting car clubs are also used a lot/popular in these areas.


```{r car_club_map_lad, fig.width = 12}

#london outline:
london.sf <- st_union(como_london.sf)
london_bbox <- st_bbox(london.sf)
#london centre:
london_c <- st_centroid(london.sf)

### map of number of operators per lad 
#-------------------------------------- 

ggm1 <- ggplot() +
  geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.9) +
  geom_sf(data = como_lad.sf, aes(fill = n_operators)) +
  geom_rect(aes(xmin = london_bbox$xmin, xmax = london_bbox$xmax, ymin = london_bbox$ymin , ymax =   london_bbox$ymax), fill = NA, colour = "black", size = 1.5) +
  scale_fill_brewer(palette = "Set1", name = "",na.translate=FALSE) +
#scale_fill_gradientn(colours=rev(rainbow(5)), name = "") +
  theme_map() +
  ylim(50, 58.5) +
  #scale_fill_manual(values = mypalette2, name = "") +
  ggtitle("The number of car club operators per local authority") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.direction = "horizontal",
        legend.position = "top") 


ggm2 <- ggplot() +
  geom_sf(data = como_london.sf, aes(fill = n_operators)) +
 # scale_fill_viridis(discrete = TRUE, name = "Number of operators",option = "E") +
  scale_fill_brewer(palette = "Set1", name = "",na.translate=FALSE) +
  guides(fill = FALSE) +
  ggtitle("London") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.title = element_text(size = 10)) 


p1 <- ggdraw() +
  draw_plot(ggm1) +
  draw_plot(ggm2, x = 0.6, y = 0.5, width = 0.25, height = 0.25)

### map of number of lots per lad 
#---------------------------------

ggm1 <- ggplot() +
  geom_polygon(data = UK, aes(x=long, y = lat, group = group), fill="grey", alpha=0.9) +
  geom_sf(data = como_lad.sf, aes(fill = n_lots_q)) +
  geom_rect(aes(xmin = london_bbox$xmin, xmax = london_bbox$xmax, ymin = london_bbox$ymin , ymax = london_bbox$ymax), fill = NA, colour = "black", size = 1.5) +
  scale_fill_viridis(discrete = TRUE, name = "",na.translate=FALSE, labels = c("1", "2-3", "4-10", "11-374")) +
#scale_fill_gradientn(colours=rev(rainbow(5)), name = "") +
  theme_map() +
  ylim(50, 58.5) +
  #scale_fill_manual(values = mypalette2, name = "") +
  ggtitle("The number of car club lots per local authority") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.direction = "horizontal",
        legend.position = "top") 

ggm2 <- ggplot() +
  geom_sf(data = como_london.sf, aes(fill = n_lots_q)) +
 # scale_fill_viridis(discrete = TRUE, name = "Number of operators",option = "E") +
  scale_fill_viridis(discrete=TRUE) +
  guides(fill = FALSE) +
  ggtitle("London") +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        plot.title = element_text(size = 10)) 

p2 <- ggdraw() +
  draw_plot(ggm1) +
  draw_plot(ggm2, x = 0.6, y = 0.5, width = 0.25, height = 0.25)

plot_grid(p1,p2,align = "hv")

```



```{r tourism, fig.width = 10}

### plot of tourism  classification over the UK

#create tourism sf object

tourism.sf <- left_join(select(lad.sf,lad,Region,geometry),select(tourism,lad,tourism_cluster)) %>%
  filter(!(Region %in% c("Scotland","Northern Ireland")) & tourism_cluster > 0) 

tourism.sf$tourism_cluster <- factor(tourism.sf$tourism_cluster) 

#get centroid of each LAD that contains car club lots

como_lad_c <- como_lad.sf %>%
  filter(!is.na(n_lots)) %>%
  select(lad_name, n_lots, n_lots_q, Region, geometry) %>%
  st_centroid()

como_lad_c2 <- como_lad_c %>%
  filter(!(Region %in% c("Scotland","Northern Ireland")))

p1 <- ggplot() +
  geom_sf(data = tourism.sf, aes(fill = tourism_cluster)) +
  scale_fill_viridis(discrete = TRUE, name = "Tourism cluster",na.translate=FALSE) +
  theme_map() +
  ggtitle("Tourism clusters in England and Wales") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.direction = "horizontal",
        legend.position = "top") 

p2 <- ggplot() +
  geom_sf(data = tourism.sf, aes(fill = tourism_cluster)) +
  scale_fill_viridis(discrete = TRUE, name = "",na.translate=FALSE) +
  geom_sf(data = como_lad_c2, aes(size = n_lots_q, colour = n_lots_q), alpha = 0.7) +
 # guides(size = guide_legend("Number of car club lots"),
  #      fill = FALSE) +
  guides(fill = FALSE, size = guide_legend("Number of car club lots"), colour = guide_legend("Number of car club lots")) +
  scale_colour_brewer(guide = "legend", palette = "Reds",labels = c("1","2-3","4-10","11-374")) +
  #scale_colour_viridis(guide = "legend") +
  scale_size_discrete(labels = c("1","2-3","4-10","11-374")) +
#  scale_colour_discrete(labels = c("1","2-3","4-10","11-374")) +
  theme_map() +
  ggtitle(" ") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10),
        legend.direction = "horizontal",
        legend.position = "top") 

plot_grid(p1,p2,align = "hv")


```

Calculate average number of lots per LAD for each cluster. 

```{r tourism2, fig.width = 8}

#number of local authorities with car clubs
tourism_como <- como_lad %>%
  group_by(lad_name) %>%
  mutate(lad_count = n()) %>%
  ungroup() %>%
  left_join(select(tourism,lad_name,tourism_cluster)) %>%
  filter(!is.na(tourism_cluster))

tourism_como$tourism_cluster <- factor(tourism_como$tourism_cluster)

tourism_como2 <- tourism_como %>%
  group_by(tourism_cluster) %>%
  summarise(lots_per_LAD = mean(n_lots))

p1 <- ggplot(tourism_como, aes(x = tourism_cluster, y = lad_count, fill = tourism_cluster)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(discrete = TRUE) +
  guides(fill = FALSE) +
  labs(x = "Tourism cluster", y = "Number of local authorities with car club bays") +
  ggtitle("Local authorities with car club bays per tourism cluster") +
  theme(plot.title = element_text(size = 10, face = "bold"))


p2 <- ggplot(tourism_como, aes(x = tourism_cluster, y = n_lots, fill = tourism_cluster)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(discrete = TRUE) +
  guides(fill = FALSE) +
  labs(x = "Tourism cluster", y = "Number of car club bays") +
  ggtitle("Car club bays per tourism cluster") +
  theme(plot.title = element_text(size = 10, face = "bold"))


#plot_grid(p1,p2, align = "hv")


ggplot(tourism_como2, aes(x = tourism_cluster, y = lots_per_LAD, fill = tourism_cluster)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(discrete = TRUE) +
  guides(fill = FALSE) +
  labs(x = "Tourism cluster", y = "Average number of car club bays") +
  ggtitle("Car club bays per tourism cluster") +
  theme(plot.title = element_text(size = 10, face = "bold"))

```


```{r accessibility, fig.width = 10}

#load data
accessibility <- read.csv(file = "../data/wrangled/accessibility_wrangled.csv")

#select column of interest
accessibility <- accessibility %>% 
  select(lad, town_time)

accessibility$town_time_q <- quantcut(accessibility$town_time, q = 5)

#create sf object
accessibility.sf <- left_join(lad_england.sf,accessibility)

como_lad_c2 <- como_lad_c %>%
  filter(!(Region %in% c("Scotland","Northern Ireland","Wales")))

p1 <- ggplot() +
  geom_sf(data = accessibility.sf, aes(fill = town_time_q)) +
  scale_fill_viridis(discrete = TRUE, name = "Travel time (minutes)", labels = c("11 - 17",
                                                                                "17 - 20",
                                                                                "20 - 22",
                                                                                "22 - 26",
                                                                                "26 - 120")) +
  theme_map() +
  ggtitle("Average travel times to the nearest town on foot or with public transport in England") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        #legend.direction = "horizontal",
        #legend.position = "top".
        legend.position = c(0.1,0.8)) 

p2 <- ggplot() +
  geom_sf(data = accessibility.sf, aes(fill = town_time_q)) +
  scale_fill_viridis(discrete = TRUE, name = "",na.translate=FALSE) +
  geom_sf(data = como_lad_c2, aes(size = n_lots_q, colour = n_lots_q), alpha = 0.7) +
  scale_size(range = c(2,12)) +
 # guides(size = guide_legend("Number of car club lots"),
  #      fill = FALSE) +
  guides(fill = FALSE, size = guide_legend("Number of car club lots"), colour = guide_legend("Number of car club lots")) +
  scale_colour_brewer(guide = "legend", palette = "Reds",labels = c("1","2-3","4-10","11-374")) +
  #scale_colour_viridis(guide = "legend") +
  scale_size_discrete(labels = c("1","2-3","4-10","11-374")) +
#  scale_colour_discrete(labels = c("1","2-3","4-10","11-374")) +
  theme_map() +
  ggtitle(" ") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
        #legend.direction = "horizontal",
        #legend.position = "top"
        legend.position = c(0.1,0.8)) 

plot_grid(p1,p2,align = "hv")

```

```{r accessibility, fig.width = 10}

#load data
parking_revenue <- read.csv(file = "../data/wrangled/parking_revenue_wrangled.csv")

parking_revenue$surplus_q <- quantcut(parking_revenue$surplus, q = 5)

#create sf object
parking_revenue.sf <- left_join(lad_england.sf,parking_revenue)

como_lad_c2 <- como_lad_c %>%
  filter(!(Region %in% c("Scotland","Northern Ireland","Wales")))

p1 <- ggplot() +
  geom_sf(data = parking_revenue.sf, aes(fill = surplus_q)) +
  scale_fill_viridis(discrete = TRUE, name = "Parking revenue (£ ,000)", labels = c("-1014 - 64", " 64 - 463", " 463 - 1230", " 1230 - 2820", " 2820 - 55900")) +
  theme_map() +
  ggtitle("Council parking revenue 2015-2016 for local authorities in England.") +
         # subtitle = "Parking data can be obtained from http://www.racfoundation.org/media-centre/parking-profits-break-three-quarters-of-a-billion") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
       # legend.direction = "horizontal",
        legend.position = c(0.1,0.8)) 

p2 <- ggplot() +
  geom_sf(data = parking_revenue.sf, aes(fill = surplus_q)) +
  scale_fill_viridis(discrete = TRUE, name = "",na.translate=FALSE) +
  geom_sf(data = como_lad_c2, aes(size = n_lots_q, colour = n_lots_q), alpha = 0.7) +
  scale_size(range = c(2,12)) +
 # guides(size = guide_legend("Number of car club lots"),
  #      fill = FALSE) +
  guides(fill = FALSE, size = guide_legend("Number of car club lots"), colour = guide_legend("Number of car club lots")) +
  scale_colour_brewer(guide = "legend", palette = "Reds",labels = c("1","2-3","4-10","11-374")) +
  #scale_colour_viridis(guide = "legend") +
  scale_size_discrete(labels = c("1","2-3","4-10","11-374")) +
#  scale_colour_discrete(labels = c("1","2-3","4-10","11-374")) +
  theme_map() +
  ggtitle(" ") +
  theme(plot.title = element_text(size = 12, face = "bold"),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 8),
       # legend.direction = "horizontal",
        legend.position = c(0.1,0.8)) 

plot_grid(p1,p2,align = "hv")


```


```{r scatter_plots, fig.width = 8}

#add travel time and parking surplus to como_lad

como_lad2 <- como_lad %>% 
  left_join(accessibility) %>%
  left_join(parking_revenue)



p1 <- ggplot(como_lad2, aes(x = n_vehicles, y = surplus, fill = n_vehicles)) +
  geom_point(shape = 21, alpha = 0.8, size = 5) +
  scale_fill_viridis(option = "D", name = "Number of vehicles") +
  labs(x = "Number of car club vehicles available", y = "Council parking surplus (£, 000)") +
  ggtitle("The number of car club vehicles per local \n authority vs council parking revenue") +
  scale_x_log10() + 
  scale_y_log10() +
  theme_classic() +
  theme(legend.position = c(0.85,0.2), plot.title = element_text(size = 12),
        legend.title = element_text(size = 8), legend.text = element_text(size = 8))

p2 <- ggplot(como_lad2, aes(x = n_vehicles, y = town_time, fill = n_vehicles)) +
  geom_point(shape = 21, alpha = 0.8, size = 5) +
  scale_fill_viridis(option = "D", name = "Number of vehicles") +
  labs(x = "Number of car club vehicles available", y = "Time to nearest town on foot or by public transport (minutes)") +
  ggtitle("The number of car club vehicles per local \n authority vs travel time to the nearest town") +
  scale_x_log10() + 
  scale_y_log10() +
  theme_classic() +
  theme(legend.position = "none",plot.title = element_text(size = 12))

plot_grid(p1, p2, nrow = 1, align = "hv")


```
